---
title: "Mass Spectrometry Imaging (MSI) Integration and Preparation"
output: rmarkdown::html_vignette
vignette: >
  %/VignetteIndexEntry{MSI Integration and Preparation}
  %/VignetteEngine{knitr::rmarkdown}
  %/VignetteEncoding{UTF-8}
---

```{r setup, message=FALSE}
library(Seurat)
library(dplyr)
library(sqldf)
library(ggplot2)
library(patchwork)
library(SingleCellExperiment)
library(mclust)
library(RColorBrewer)
library(ggpubr)
library(data.table)
library(plotly)
library(spatstat)
library(gplots)
library(corrplot)
library(stringr)
library(VennDiagram)
library(grid)
library(reshape2)
library(tidyr)
library(Matrix)

# ──────────────────────────────────────────────────────────────
# USER-CONFIGURABLE PATHS
# Update these paths to match your local environment.
# ──────────────────────────────────────────────────────────────
study_name <- "ymp_d28"
study_path <- "D:/GoogleDrive/spatial_leishmania/spatial/_EXPERIMENTS/SD22.5.1_YMP_day28pi/"
coregistration_path <- paste0(study_path, "coregistration/")

save_path <- paste0(study_path, "R/woI4/")

all_samples <- c("334-I2", "334-N2-I4", "334-N3", "345-I3", "345-I5", "345-N1", "345-N4")
sample_group <- c("inf", "naive_inf", "naive", "inf", "inf", "naive", "naive")
```

```{r load_coreg_data}
# Load coregistration CSV files for each sample and combine positive/negative ion modes
list_coreg <- list()
list_both_coreg <- list()

# Infected mice
for (item in c("I2", "I3", "I4", "I5")) {
  for (ion_mode in c("neg", "pos")) {
    key <- paste0(item, "_", ion_mode)
    list_coreg[[key]] <- read.csv(paste0(coregistration_path, item, "/", ion_mode, "/infected_", item, ".csv"))
    rownames(list_coreg[[key]]) <- list_coreg[[key]]$Var1
  }
  key1 <- paste0(item, "_neg")
  key2 <- paste0(item, "_pos")
  list_both_coreg[[item]] <- dplyr::full_join(list_coreg[[key1]], list_coreg[[key2]], by = "Var1")

  rownames(list_both_coreg[[item]]) <- list_both_coreg[[item]]$Var1
  list_both_coreg[[item]] <- list_both_coreg[[item]][, c(grep("^mz", colnames(list_both_coreg[[item]]), value = TRUE))]
  list_both_coreg[[item]] <- list_both_coreg[[item]] %>% mutate_all(~replace_na(., 0))

  list_coreg[[key1]] <- list_coreg[[key1]][, c(grep("^mz", colnames(list_coreg[[key1]]), value = TRUE))]
  list_coreg[[key1]] <- list_coreg[[key1]] %>% mutate_all(~replace_na(., 0))

  list_coreg[[key2]] <- list_coreg[[key2]][, c(grep("^mz", colnames(list_coreg[[key2]]), value = TRUE))]
  list_coreg[[key2]] <- list_coreg[[key2]] %>% mutate_all(~replace_na(., 0))
}

# Naive mice
for (item in c("N1", "N2", "N3", "N4")) {
  for (ion_mode in c("neg", "pos")) {
    key <- paste0(item, "_", ion_mode)
    list_coreg[[key]] <- read.csv(paste0(coregistration_path, item, "/", ion_mode, "/naive_", item, ".csv"))
    rownames(list_coreg[[key]]) <- list_coreg[[key]]$Var1
  }
  key1 <- paste0(item, "_neg")
  key2 <- paste0(item, "_pos")
  list_both_coreg[[item]] <- dplyr::full_join(list_coreg[[key1]], list_coreg[[key2]], by = "Var1")

  rownames(list_both_coreg[[item]]) <- list_both_coreg[[item]]$Var1
  list_both_coreg[[item]] <- list_both_coreg[[item]][, c(grep("^mz", colnames(list_both_coreg[[item]]), value = TRUE))]
  list_both_coreg[[item]] <- list_both_coreg[[item]] %>% mutate_all(~replace_na(., 0))

  list_coreg[[key1]] <- list_coreg[[key1]][, c(grep("^mz", colnames(list_coreg[[key1]]), value = TRUE))]
  list_coreg[[key1]] <- list_coreg[[key1]] %>% mutate_all(~replace_na(., 0))

  list_coreg[[key2]] <- list_coreg[[key2]][, c(grep("^mz", colnames(list_coreg[[key2]]), value = TRUE))]
  list_coreg[[key2]] <- list_coreg[[key2]] %>% mutate_all(~replace_na(., 0))
}
```

```{r create_sparse_matrix_to_10X}
# Convert each lipid coregistration data frame to 10X-compatible format
# (sparse matrix + barcodes + features), then create Seurat objects

seuratObjList <- list()

for (item in names(list_both_coreg)) {
  mtx_path <- paste0(coregistration_path, item, "/10X/")
  dir.create(mtx_path, showWarnings = FALSE, recursive = TRUE)

  df <- t(data.matrix(list_both_coreg[[item]]))
  sparse_mat <- as(df, "dgCMatrix")

  writeMM(sparse_mat, file = paste0(mtx_path, "matrix.mtx"))
  write(rownames(df), file = paste0(mtx_path, "features.tsv"))
  write(colnames(df), file = paste0(mtx_path, "barcodes.tsv"))

  mtx10x <- Read10X(mtx_path, gene.column = 1)
  seuratObjList[[item]] <- CreateSeuratObject(counts = mtx10x, assay = "RNA")
  seuratObjList[[item]]$orig.ident <- item
}
```

```{r integrate_MSI}
seuratObjList <- lapply(X = seuratObjList, FUN = SCTransform, verbose = FALSE)

features <- SelectIntegrationFeatures(object.list = seuratObjList, nfeatures = 3000)
seuratObjList <- PrepSCTIntegration(object.list = seuratObjList, anchor.features = features)

immune.anchors <- FindIntegrationAnchors(
  object.list = seuratObjList,
  normalization.method = "SCT",
  anchor.features = features
)

integrated_msi <- IntegrateData(anchorset = immune.anchors, normalization.method = "SCT")
```

```{r clustering}
res <- 0.5
dims <- 30

integrated_msi <- RunPCA(integrated_msi, assay = "integrated", verbose = FALSE)
ElbowPlot(integrated_msi)

integrated_msi <- FindNeighbors(integrated_msi, reduction = "pca", dims = 1:dims)
integrated_msi <- FindClusters(integrated_msi, verbose = FALSE, resolution = res)
integrated_msi <- RunUMAP(integrated_msi, reduction = "pca", dims = 1:dims)
integrated_msi <- RunTSNE(integrated_msi, reduction = "pca", dims = 1:dims)

pdf(paste0(save_path, "DimPlot_MSI_PC1to", dims, "_res", res, ".pdf"))
  DimPlot(integrated_msi, reduction = "tsne", label = TRUE) + NoLegend()
  DimPlot(integrated_msi, reduction = "umap", label = TRUE) + NoLegend()
  DimPlot(integrated_msi, reduction = "tsne", group.by = "orig.ident")
  DimPlot(integrated_msi, reduction = "umap", group.by = "orig.ident")
dev.off()

# Proportions
prop.table(table(Idents(integrated_msi), integrated_msi$orig.ident), margin = 2)
write.csv(
  prop.table(table(Idents(integrated_msi), integrated_msi$orig.ident), margin = 2),
  paste0(save_path, "/markers/msi_ident_proportions_sample.csv"),
  row.names = TRUE
)

saveRDS(integrated_msi, paste0(save_path, "integrated_msi_dims", dims, "_res_", res, ".Rds"))
```

```{r find_markers}
DefaultAssay(integrated_msi) <- "SCT"
integrated_msi <- PrepSCTFindMarkers(integrated_msi, assay = "SCT")

all_markers <- FindAllMarkers(integrated_msi, only.pos = TRUE, min.pct = 0.25, logfc.threshold = 0.25, assay = "SCT")
write.csv(all_markers, paste0(save_path, "/markers/", "integrated_msi_markers_dims_", dims, "_res", res, ".csv"), row.names = TRUE)

all_markers <- read.csv(paste0(save_path, "/markers/", "integrated_msi_markers_dims_", dims, "_res", res, ".csv"), header = TRUE)

all_markers %>%
  group_by(cluster) %>%
  top_n(n = 10, wt = avg_log2FC) -> top10

pdf(paste0(save_path, "MSI_heatmap.pdf"), width = 15, height = 20)
  DoHeatmap(integrated_msi, features = top10$gene) + NoLegend()
dev.off()
```
